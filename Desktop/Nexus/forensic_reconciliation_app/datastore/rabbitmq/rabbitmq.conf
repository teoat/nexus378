# Forensic Reconciliation + Fraud Platform - RabbitMQ Configuration
# RabbitMQ 3.12+ Configuration File

# =============================================================================
# NETWORK CONFIGURATION
# =============================================================================

# Listeners
listeners.tcp.default = 5672
management.tcp.port = 15672

# =============================================================================
# SECURITY CONFIGURATION
# =============================================================================

# Default user and password
default_user = admin
default_pass = ${RABBITMQ_PASSWORD:-forensic_secure_2024}
default_vhost = /

# Authentication backend
auth_backends.1 = internal

# =============================================================================
# RESOURCE LIMITS
# =============================================================================

# Memory limit
vm_memory_high_watermark.relative = 0.6
vm_memory_high_watermark_paging_ratio = 0.5

# Disk space limit
disk_free_limit.relative = 2.0

# File descriptor limit
file_handles_high_watermark = 100000

# =============================================================================
# QUEUE CONFIGURATION
# =============================================================================

# Default queue arguments
default_consumer_prefetch = 50
default_consumer_prefetch_count = 50

# Queue master locator
queue_master_locator = min-masters

# =============================================================================
# EXCHANGE CONFIGURATION
# =============================================================================

# Default exchange type
default_exchange_type = direct

# =============================================================================
# CLUSTER CONFIGURATION
# =============================================================================

# Cluster formation
cluster_formation.peer_discovery_backend = rabbit_peer_discovery_classic_config
cluster_formation.classic_config.nodes.1 = rabbit@rabbitmq

# =============================================================================
# MANAGEMENT CONFIGURATION
# =============================================================================

# Management plugin
management.load_definitions = /etc/rabbitmq/definitions.json
management.http_log_dir = /var/log/rabbitmq/management

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================

# Log level
log.console.level = info
log.file.level = info
log.file.rotation.date = $D0
log.file.rotation.size = 10485760

# =============================================================================
# PERFORMANCE TUNING
# =============================================================================

# TCP settings
tcp_listen_options.backlog = 128
tcp_listen_options.nodelay = true
tcp_listen_options.exit_on_close = false

# Heartbeat
heartbeat = 60

# =============================================================================
# PLUGIN CONFIGURATION
# =============================================================================

# Enable plugins
plugins.enable = rabbitmq_management,rabbitmq_management_visualiser,rabbitmq_tracing

# =============================================================================
# POLICY CONFIGURATION
# =============================================================================

# Default policies
default_policies.1.name = forensic_platform_policy
default_policies.1.pattern = ^forensic\.
default_policies.1.definition.ha-mode = all
default_policies.1.definition.ha-sync-mode = automatic
default_policies.1.definition.message-ttl = 86400000
default_policies.1.definition.max-length = 10000
default_policies.1.priority = 0

# =============================================================================
# QUEUE DEFINITIONS
# =============================================================================

# AI Agent Communication Queues
default_queues.1.name = ai.reconciliation.queue
default_queues.1.durable = true
default_queues.1.auto_delete = false
default_queues.1.arguments.x-message-ttl = 3600000

default_queues.2.name = ai.fraud.detection.queue
default_queues.2.durable = true
default_queues.2.auto_delete = false
default_queues.2.arguments.x-message-ttl = 7200000

default_queues.3.name = ai.risk.assessment.queue
default_queues.3.durable = true
default_queues.3.auto_delete = false
default_queues.3.arguments.x-message-ttl = 3600000

default_queues.4.name = ai.evidence.processing.queue
default_queues.4.durable = true
default_queues.4.auto_delete = false
default_queues.4.arguments.x-message-ttl = 1800000

default_queues.5.name = ai.litigation.support.queue
default_queues.5.durable = true
default_queues.5.auto_delete = false
default_queues.5.arguments.x-message-ttl = 7200000

# Priority Queues
default_queues.6.name = priority.high.queue
default_queues.6.durable = true
default_queues.6.auto_delete = false
default_queues.6.arguments.x-max-priority = 10

default_queues.7.name = priority.medium.queue
default_queues.7.durable = true
default_queues.7.auto_delete = false
default_queues.7.arguments.x-max-priority = 5

default_queues.8.name = priority.low.queue
default_queues.8.durable = true
default_queues.8.auto_delete = false
default_queues.8.arguments.x-max-priority = 3

# Dead Letter Queues
default_queues.9.name = dead.letter.queue
default_queues.9.durable = true
default_queues.9.auto_delete = false

# =============================================================================
# EXCHANGE DEFINITIONS
# =============================================================================

# AI Service Exchanges
default_exchanges.1.name = ai.reconciliation.exchange
default_exchanges.1.type = direct
default_exchanges.1.durable = true

default_exchanges.2.name = ai.fraud.detection.exchange
default_exchanges.2.type = topic
default_exchanges.2.durable = true

default_exchanges.3.name = ai.risk.assessment.exchange
default_exchanges.3.type = direct
default_exchanges.3.durable = true

default_exchanges.4.name = ai.evidence.processing.exchange
default_exchanges.4.type = fanout
default_exchanges.4.durable = true

default_exchanges.5.name = ai.litigation.support.exchange
default_exchanges.5.type = direct
default_exchanges.5.durable = true

# Priority Exchange
default_exchanges.6.name = priority.exchange
default_exchanges.6.type = direct
default_exchanges.6.durable = true

# =============================================================================
# BINDING DEFINITIONS
# =============================================================================

# AI Service Bindings
default_bindings.1.source = ai.reconciliation.exchange
default_bindings.1.destination = ai.reconciliation.queue
default_bindings.1.destination_type = queue
default_bindings.1.routing_key = reconciliation.job

default_bindings.2.source = ai.fraud.detection.exchange
default_bindings.2.destination = ai.fraud.detection.queue
default_bindings.2.destination_type = queue
default_bindings.2.routing_key = fraud.detection.*

default_bindings.3.source = ai.risk.assessment.exchange
default_bindings.3.destination = ai.risk.assessment.queue
default_bindings.3.destination_type = queue
default_bindings.3.routing_key = risk.assessment

default_bindings.4.source = ai.evidence.processing.exchange
default_bindings.4.destination = ai.evidence.processing.queue
default_bindings.4.destination_type = queue

default_bindings.5.source = ai.litigation.support.exchange
default_bindings.5.destination = ai.litigation.support.queue
default_bindings.5.destination_type = queue
default_bindings.5.routing_key = litigation.support

# Priority Bindings
default_bindings.6.source = priority.exchange
default_bindings.6.destination = priority.high.queue
default_bindings.6.destination_type = queue
default_bindings.6.routing_key = high

default_bindings.7.source = priority.exchange
default_bindings.7.destination = priority.medium.queue
default_bindings.7.destination_type = queue
default_bindings.7.routing_key = medium

default_bindings.8.source = priority.exchange
default_bindings.8.destination = priority.low.queue
default_bindings.8.destination_type = queue
default_bindings.8.routing_key = low

# =============================================================================
# USER DEFINITIONS
# =============================================================================

# Admin user
default_users.1.user = admin
default_users.1.password = ${RABBITMQ_PASSWORD:-forensic_secure_2024}
default_users.1.tags = administrator

# AI Service user
default_users.2.user = ai_service
default_users.2.password = ${RABBITMQ_AI_PASSWORD:-ai_secure_2024}
default_users.2.tags = management

# Gateway user
default_users.3.user = gateway
default_users.3.password = ${RABBITMQ_GATEWAY_PASSWORD:-gateway_secure_2024}
default_users.3.tags = management

# =============================================================================
# PERMISSIONS
# =============================================================================

# Admin permissions
default_permissions.1.user = admin
default_permissions.1.vhost = /
default_permissions.1.configure = .*
default_permissions.1.write = .*
default_permissions.1.read = .*

# AI Service permissions
default_permissions.2.user = ai_service
default_permissions.2.vhost = /
default_permissions.2.configure = ai\..*
default_permissions.2.write = ai\..*
default_permissions.2.read = ai\..*

# Gateway permissions
default_permissions.3.user = gateway
default_permissions.3.vhost = /
default_permissions.3.configure = ^$
default_permissions.3.write = .*
default_permissions.3.read = .*

# =============================================================================
# ADVANCED CONFIGURATION
# =============================================================================

# Mnesia table loading timeout
mnesia_table_loading_timeout = 300000

# Queue master locator
queue_master_locator = min-masters

# Cluster partition handling
cluster_partition_handling = pause_minority

# Network partition recovery
net_ticktime = 60

# =============================================================================
# MONITORING CONFIGURATION
# =============================================================================

# Enable detailed monitoring
management.rates_mode = detailed

# Enable tracing
trace.vhost = /
trace.exchange = ai.trace.exchange
trace.queue = ai.trace.queue

# =============================================================================
# SECURITY ENHANCEMENTS
# =============================================================================

# Disable guest user
loopback_users = none

# SSL configuration (if needed)
# ssl_options.cacertfile = /etc/rabbitmq/ca_certificate.pem
# ssl_options.certfile = /etc/rabbitmq/server_certificate.pem
# ssl_options.keyfile = /etc/rabbitmq/server_key.pem
# ssl_options.verify = verify_peer
# ssl_options.fail_if_no_peer_cert = false
